{% load static %}
{% load random_nonce %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prize Picker</title>
    <link rel="stylesheet" type="text/css" href="{% static 'css/game.css' %}">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script src="{% static 'css/js/jquery-1.11.3.min.js' %}"></script>
    <script src="{% static 'css/js/gamescript.js' %}"></script>
    {% csrf_token %}
    <style>
        .wrapperlootlist {
            display: flex;
            flex-wrap: wrap;
            justify-content: left;
        }
        .game {
            display: flex;
            flex-wrap: wrap;
            justify-content: left;
        }
        .cardslootlist {
            flex: 1 1 200px;
            margin: 10px;
            box-sizing: border-box;
        }
        .sliderlootlist {
            display: flex;
            flex-wrap: wrap;
            justify-content: left;
        }
        .spinner-arrow {
            width: 50px;
            height: 50px;
            z-index: 10;
        }
        .cards-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: flex-start;
        }
        .individuallootelement {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            padding: 15px;
        }
        .individuallootelement p {
            margin: 5px 0;
        }
        .cards {
            margin-right: 15px;
            margin-left: 15px;
            flex: 1 1 200px;
            margin: 10px;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            align-items: left;
        }
        .slider img {
            width: 15vh;
            height: 20vh;
            margin-top: -2vh;
            margin-left: -0.5vh;
            border: 2px solid;
            border-color: transparent;
            border-radius: 7px;
        }
    </style>
 $(document).ready(function() {
    console.log("jQuery is loaded.");
    $('#start').on('click', function() {
        console.log('Button clicked.');
        var gameSlug = $(this).data('game-slug');  // Assuming the slug is stored in a data attribute
        var gameId = $(this).data('game-id');  // Assuming the game ID is stored in a data attribute
        var csrfToken = '{{ csrf_token }}';
        var url = "{% url 'showcase:create_outcome' slug=game.slug %}".replace('dummy_slug', gameSlug);

        console.log('Game Slug:', gameSlug);
        console.log('Game ID:', gameId);
        console.log('CSRF Token:', csrfToken);
        console.log('URL:', url);

        $.ajax({
            type: 'POST',
            url: url,
            data: {
                csrfmiddlewaretoken: csrfToken,
                game_id: gameId  // Send game_id in request data
            },
            success: function(response) {
                if (response.status === 'success') {
                    console.log('Outcome created successfully!');
                    // Handle success case here
                } else {
                    console.error(response.message);
                }
            },
            error: function(error) {
                console.error('Error:', error);
            }
        });
    });
});

        function updateWheelContents(choices) {
            var slider = $('#slider');
            slider.empty();

            choices.forEach(function(choice) {
                var choiceHtml = `
                    <div class="cards">
                        <img src="${choice.file_url}" alt="${choice.choice_text}">
                        <h2>${choice.value} ðŸ’Ž</h2>
                    </div>
                `;
                slider.append(choiceHtml);
            });

            randomizeContents();
        }

        function randomizeContents() {
            $('div#slider').each(function() {
                var $div_parent = $(this);
                var $divsArr = $div_parent.children('div.cards');
                $divsArr.sort(function(a, b) {
                    var temp = parseInt(Math.random() * 10);
                    var isOddOrEven = temp % 2;
                    var isPosOrNeg = temp > 5 ? 1 : -1;
                    return (isOddOrEven * isPosOrNeg);
                }).appendTo($div_parent);
            });

            setTimeout(function() {
                console.log("Stop the wheel");
            }, 9000);
        }
</head>
<body>
    <div>
        {% for game in games %}
        <div class="boxes" style="margin-left: 41%; margin-right: 50%; position: absolute;">
            <img src="{{ game.image.url }}" class="game-image" alt="{{ game.name }}">
            <h2 style="display: flex; flex-direction: row; text-align: center; margin-right: auto; margin-left: auto;">{{ game.name }}</h2>
        </div>
        <p>Random Nonce: {{ nonce }}</p>
        <button class="start" id="start" data-game-slug="{{ game.slug }}">Spin!</button>
<script>
  $(document).ready(function() {
    console.log("jQuery is loaded.");
    $('#start').on('click', function() {
        console.log('Button clicked.');
        var gameSlug = $(this).data('game-slug');
        var csrfToken = '{{ csrf_token }}';
        var url = "{% url 'showcase:create_outcome' slug='dummy_slug' %}".replace('dummy_slug', gameSlug);

        console.log('Game Slug:', gameSlug);
        console.log('CSRF Token:', csrfToken);
        console.log('URL:', url);

        $.ajax({
            type: 'POST',
            url: url,
            data: {
                csrfmiddlewaretoken: csrfToken,
                game_slug: gameSlug // Include the slug in the request data
            },
            success: function(response) {
                if (response.status === 'success') {
                    console.log('Choices received successfully!');
                    updateWheelContents(response.choices);
                } else {
                    console.error(response.message);
                }
            },
            error: function(error) {
                console.error('Error:', error);
            }
        });
    });
});

</script>


        {% endfor %}
    </div>

    <div class="popup" id="popup">
        <div class="contents">
            <span class="close">&times;</span>
            <div class="text" style="z-index: 5;">
                <h1>Congratulations!</h1>
                <h2>You got:</h2>
                <h1 id="cardname"></h1>
            </div>
        </div>
    </div>

    <div class="wrapper">
        <div class="container" style="height: 37.5vh;">
            <div class="slider" id="slider">
                {% for choice in choices %}
                <div id="{{ choice.choice_text }}" class="cards">
                    {% with color=game|get_color:choice %}
                    <div class="lootelement" style="background: url({% static 'css/images/'|add:color|add:'.png' %}); padding: 6%; margin-left: 22px;">
                        <img src="{{ choice.file.url }}" alt="{{ choice.choice_text }}">
                    </div>
                    {% endwith %}
                    <h2 style="margin-left: 22px;">{{ choice.value }} ðŸ’Ž</h2>
                </div>
                {% endfor %}
            </div>
            <img id="selector" class="spinner-arrow" src="{% static 'css/images/opener_selector.svg' %}" alt="spinner-arrow">
        </div>

        <h2 style="text-align: center; margin-bottom: -3%;">Loot Drop Table</h2>
        <div class="game" style="display: flex; flex-direction: row; justify-content: left;">
            <div class="sliderlootlist" id="">
                {% for choice in choices reversed %}
                <div id="{{ choice.choice_text }}" class="cards" style="margin-right: 15px; margin-left: 15px; flex: 1 1 200px; margin: 10px; box-sizing: border-box; display: flex; flex-direction: column; align-items: left;">
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</body>
</html>
